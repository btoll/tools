#!/bin/bash
# https://stackoverflow.com/questions/424071/list-all-the-files-for-a-commit-in-git

COMMIT="HEAD"
REGEX=
LIMIT=
VIM=

usage() {
    echo "GIT-LS"
    echo
    echo "Usage: $0 [args]"
    echo
    echo "Args:"
    echo "--commit, -commit, -c : List the files in this commit (defaults to HEAD)."
    echo
    echo "--edit, -edit, -e     : Open all listed files in Vim using:"
    echo "          b = no windows (just buffers)"
    echo "          h = horizontally-split windows"
    echo "          t = tabs"
    echo "          v = vertically-split windows"
    echo "Note that if a regex pattern is given that only the files that match this pattern will be opened in Vim."
    echo
    echo " -help, -h            : Help"
    echo
    echo "--limit, -limit, -l   : Limit the number of files listed."
    echo
    echo "--regex, -regex, -r   : Specify a pattern that will be used to search through all the files that make up the commit."
    echo
}

# Swap out for user-provided options if given.
while [ "$#" -gt 0 ]; do
    OPT="$1"
    case $OPT in
        --commit|-commit|-c) shift; COMMIT=$1 ;;
        --edit|-edit|-e)
            shift
            case $1 in
                b) VIM=" " ;;
                h) VIM="-o" ;;
                t) VIM="-p" ;;
                v) VIM="-O" ;;
            esac
            ;;
        -help|-h) usage; exit 0 ;;
        --limit|-limit|-l) shift; LIMIT=$1 ;;
        --regex|-regex|-r) shift; REGEX=$1 ;;
    esac
    shift
done

CMD="git diff-tree --no-commit-id --name-only -r $COMMIT"

if [ -n "$REGEX" ]; then
    # Use the `-l` switch to only display the file name.
    CMD="$CMD | xargs grep -l $REGEX"
fi

if [ -n "$LIMIT" ]; then
    CMD="$CMD | head -$LIMIT"
fi

if [ -n "$VIM" ]; then
    # http://stackoverflow.com/a/16579925
    if [[ ! ${PWD##*/} =~ ^SDK ]]; then
        echo "You need to run this command from the toplevel of the working tree."
        exit 1
    fi

    CMD='vim '"$VIM"' $('"$CMD"')'
fi

eval $CMD

