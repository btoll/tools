#!/bin/bash

BLAME=false
BLOB_URL=https://github.com/extjs/SDK/blob/
BLAME_URL=https://github.com/extjs/SDK/blame/
COMMIT=
DRY_RUN=false
FILE=
HASH=
QUERY=
REMOTE_BRANCH=${GIT_HUB_REMOTE_BRANCH:-sencha-5.0.x}
URL=

usage() {
    echo "GIT-HUB"
    echo
    echo "Usage: $0 [args]"
    echo
    echo "Args:"
    echo "--blame, -blame       : If given will open the branch in the Blame view."
    echo "                        Not applicable if given a topic branch or hash."
    echo
    echo "--branch, -branch, -b : If given, will get the hash of the local topic branch."
    echo "                        Note that this should be thought of as the same as the"
    echo "                        hash option."
    echo
    echo "--dry-run, -d         : Will echo the full URL to STDOUT only and not attempt a"
    echo "                        network request."
    echo
    echo "--file, -file, -f     : The file to lookup on GitHub. Accepts relative paths."
    echo
    echo "--hash, -hash, -h     : The commit hash to lookup on GitHub."
    echo
    echo "--remote, -remote, -r : The branch to use as the base lookup branch on GitHub."
    echo '                        Defaults to the value of $GIT_HUB_REMOTE_BRANCH'
    echo
    echo "--tag, -tag, -t       : It given, will get the hash of the tag."
    echo "                        Note that this should be thought of as the same as the"
    echo "                        hash option."
    echo
}

# Swap out for user-provided options if given.
while [ "$#" -gt 0 ]; do
    OPT="$1"
    case $OPT in
        --blame|-blame) BLAME=true ;;
        --branch|-branch|-b) shift; COMMIT=$1 ;;
        --dry-run|-d) DRY_RUN=true ;;
        --file|-file|-f) shift; FILE=$1 ;;
        --hash|-hash|-h) shift; HASH=$1 ;;
        -help) usage; exit 0 ;;
        --remote|-remote|-r) shift; REMOTE_BRANCH=$1 ;;
        --tag|-tag|-t) shift; COMMIT=$1 ;;
    esac
    shift
done

if [[ ( -n "$HASH" ) || ( -n "$COMMIT" ) ]]; then
    # If given a topic branch or tag, simply get its hash.
    if [[ -n "$COMMIT" ]]; then
        HASH=$(git show "$COMMIT" | grep commit | awk '{print $2}')
    fi

    URL="https://github.com/extjs/SDK/commit/$HASH"
else
    QUERY=$(git rev-parse --show-prefix)

    if [ -n "$FILE" ]; then
        QUERY+="$FILE"
    fi

    if [ -n "$REMOTE" ]; then
        REMOTE_BRANCH="$REMOTE"
    fi

    if $BLAME; then
        URL="$BLAME_URL$REMOTE_BRANCH/$QUERY"
    else
        URL="$BLOB_URL$REMOTE_BRANCH/$QUERY"
    fi
fi

echo $URL

if [ "$DRY_RUN" = false ]; then
    open $URL
fi

