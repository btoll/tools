#!/bin/bash

# Delimiter.
D='|'
FIELDS=("Hash (short)   -> " "Author name    -> " "Author email   -> " "Merge date     -> " "Commit message -> ")
FORMAT=
LOCATION=
OPEN_IN_BROWSER=false
PATTERN=
PREV_IFS=
SHA=
URL=https://github.com/extjs/SDK/commit/

#usage() {
#    echo "GIT-LS"
#    echo
#    echo "Usage: $0 [args]"
#    echo
#    echo "Args:"
#    echo "--commit, -commit, -c : List the files in this commit (defaults to HEAD)."
#    echo
#    echo "--edit, -edit, -e     : Open all listed files in Vim using:"
#    echo "          b = no windows (just buffers)"
#    echo "          h = horizontally-split windows"
#    echo "          t = tabs"
#    echo "          v = vertically-split windows"
#    echo "Note that if a pattern is given that only the files that match this pattern will be opened in Vim."
#    echo
#    echo " -help, -h            : Help"
#    echo
#    echo "--limit, -limit, -l   : Limit the number of files listed."
#    echo
#    echo "--pattern, -pattern, -p   : Specify a pattern that will be used to search through all the files that make up the commit."
#    echo
#}

# Swap out for user-provided options if given.
while [ "$#" -gt 0 ]; do
    OPT="$1"
    case $OPT in
        --format|-format|-f) shift; FORMAT=$1 ;;
        --location|-location|-l) shift; LOCATION=$1 ;;
        #-help|-h) usage; exit 0 ;;
        --open-in-browser) OPEN_IN_BROWSER=true ;;
        --pattern|-pattern|-p) shift; PATTERN=$1 ;;
    esac
    shift
done

FORMAT=${FORMAT:-"%h$D%an$D%ae$D%cd$D%s"}
LOCATION=${LOCATION:=$(pwd)}

git log --pretty="$FORMAT" -S"$PATTERN" -- "$LOCATION" > tmp
wait

# Save previous (global) IFS.
PREV_IFS="$IFS"
IFS="$D"

while read LINE
do
    # Disable backslash escaping and read words into an array.
    read -r -a ARR <<<"$LINE"

    # Apparently, when the lines are read into the array that it uses the default ' ' delimiter.
    SHA=$(echo $LINE | cut -d' ' -f1)
    #URL="$URL$SHA"
    URL="https://github.com/extjs/SDK/commit/$SHA"

    # We can only now add the 6th arr element now that we have the SHA from each search result.
    FIELDS[5]="Url            ->  $URL"

    # Get the index for each field to lookup the values in each array.
    # http://www.linuxjournal.com/content/bash-arrays
    echo
    for n in ${!FIELDS[*]}
    do
        printf "%s\n" "${FIELDS[n]} ${ARR[n]}"
    done

    if $OPEN_IN_BROWSER; then
        open $URL
    fi
done < tmp

# Restore previous IFS.
IFS="$PREV_IFS"

# Add a final blank line for formatting, i.e., a blank line before the prompt.
echo

rm tmp
